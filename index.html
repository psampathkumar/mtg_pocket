<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>MTG Pocket</title>
<script type="module" src="https://cdn.jsdelivr.net/npm/hover-tilt/dist/hover-tilt.js"></script>
<style>
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,Arial;background:radial-gradient(circle at top,#1b1b2f,#05050a);color:#fff;min-height:100vh;overflow-x:hidden}
header{display:flex;justify-content:space-between;align-items:center;padding:clamp(0.5rem,3vw,1rem) clamp(0.75rem,4vw,1.5rem);background:rgba(0,0,0,.6);backdrop-filter:blur(6px);gap:0.5rem;flex-wrap:wrap}
header h1{font-size:clamp(1.2rem,4vw,1.8rem);margin:0}
button{background:linear-gradient(135deg,#4facfe,#00f2fe);border:none;border-radius:10px;padding:clamp(0.5rem,2vw,0.6rem) clamp(0.75rem,3vw,1rem);font-weight:600;cursor:pointer;font-size:clamp(0.8rem,2vw,1rem);white-space:nowrap}
button:disabled{opacity:.4;cursor:not-allowed}
select{background:#111;color:#fff;border-radius:8px;padding:0.4rem;border:1px solid #333;font-size:clamp(0.8rem,2vw,1rem)}
.controls{display:flex;gap:clamp(0.5rem,2vw,1rem);flex-wrap:wrap;padding:clamp(0.5rem,2vw,1rem);align-items:center;font-size:clamp(0.85rem,2vw,1rem)}
.stats{padding:clamp(0.5rem,2vw,1rem);display:grid;grid-template-columns:repeat(auto-fit,minmax(min(140px,100%),1fr));gap:clamp(0.5rem,2vw,1rem)}
.statBox{background:#111;padding:clamp(0.75rem,2vw,1rem);border-radius:12px;cursor:pointer;text-align:center;font-size:clamp(0.85rem,2vw,1rem)}
.statBox.active{outline:2px solid #4facfe}
.progress{height:8px;background:#222;border-radius:6px;overflow:hidden;margin-top:6px}
.progress div{height:100%;background:linear-gradient(90deg,#4facfe,#00f2fe)}
.cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(min(120px,45vw),1fr));gap:clamp(0.5rem,2vw,1rem);padding:clamp(0.5rem,2vw,1rem)}
.card{
  position:relative;
  background:#111;
  border-radius:clamp(12px,3vw,16px);
  cursor:pointer;
  overflow:visible;
}
.card .card-inner{
  position:relative;
  width:100%;
  padding-bottom:140%;
  transform-style:preserve-3d;
  transition:transform 0.6s;
}
.card .card-inner.no-transition{
  transition:none;
}
.card-front,
.card-back{
  position:absolute;
  top:0;
  left:0;
  width:100%;
  height:100%;
  backface-visibility:hidden;
  -webkit-backface-visibility:hidden;
  border-radius:clamp(12px,3vw,16px);
  overflow:hidden;
}
.card-front{
  z-index:2;
  transform:rotateY(0deg);
}
.card-back{
  transform:rotateY(180deg);
}
.card-front img,
.card-back img{
  width:100%;
  height:100%;
  display:block;
  object-fit:cover;
}
.card:hover{box-shadow:0 20px 40px rgba(0,0,0,.6)}
.count{position:absolute;bottom:clamp(4px,1vw,6px);right:clamp(4px,1vw,6px);background:rgba(0,0,0,.7);padding:2px 6px;border-radius:8px;font-size:clamp(0.7rem,2vw,0.75rem);z-index:2}
.flip-indicator{position:absolute;bottom:clamp(4px,1vw,6px);left:clamp(4px,1vw,6px);background:rgba(0,0,0,.7);padding:2px 6px;border-radius:8px;font-size:clamp(0.7rem,2vw,0.75rem);z-index:2}
.new-card::after{content:'NEW';position:absolute;top:6px;left:6px;background:#ffd700;color:#000;font-weight:700;padding:2px 6px;border-radius:4px;font-size:clamp(0.65rem,2vw,0.75rem);z-index:10}
.story-card::before{content:'STORY';position:absolute;top:6px;right:6px;background:#3498db;color:#fff;font-weight:700;padding:2px 6px;border-radius:4px;font-size:clamp(0.65rem,2vw,0.75rem);z-index:10}
.card-placeholder{position:relative;background:#1a1a2a;border:2px dashed #333;border-radius:clamp(12px,3vw,16px);overflow:hidden;display:flex;align-items:center;justify-content:center;aspect-ratio:2.5/3.5;color:#666;font-size:clamp(0.8rem,2vw,1rem);font-weight:600}
.rarity-common{border:2px solid #999}
.rarity-uncommon{border:2px solid #1eff00}
.rarity-rare{border:2px solid #0070dd}
.rarity-mythic{border:2px solid #ff8000}
.card.exiting{border:none !important}

@keyframes ripOpen{
  0%{transform:scale(1) rotate(0deg);filter:brightness(1);clip-path:none}
  15%{transform:scale(1.05) rotate(-3deg);filter:brightness(1.2);clip-path:none}
  30%{transform:scale(1.05) rotate(3deg);filter:brightness(1.2);clip-path:none}
  45%{transform:scale(1) rotate(0deg);filter:brightness(1);clip-path:none}
  50%, 69%{
    transform:scale(1) rotate(0deg);
    filter:brightness(1);
    clip-path:none;
  }
  70%{
    clip-path:polygon(0 0, 100% 0, 100% 30%, 0 35%);
    filter:brightness(2);
  }
  85%{
    clip-path:polygon(0 0, 100% 0, 100% 30%, 0 35%);
    transform:translateY(-40px) scale(1.05);
    opacity:0.5;
  }
  100%{
    clip-path:polygon(0 0, 100% 0, 100% 30%, 0 35%);
    transform:translateY(-80px) scale(1);
    opacity:0;
  }
}
@keyframes ripOpenBottom{
  0%, 69%{
    opacity:0;
    clip-path:polygon(0 35%, 100% 30%, 100% 100%, 0 100%);
    transform:translateY(0) scale(1);
  }
  70%{
    opacity:1;
    clip-path:polygon(0 35%, 100% 30%, 100% 100%, 0 100%);
    transform:translateY(0) scale(1);
  }
  85%{
    clip-path:polygon(0 35%, 100% 30%, 100% 100%, 0 100%);
    transform:translateY(40px) scale(0.95);
    opacity:0.5;
  }
  100%{
    clip-path:polygon(0 35%, 100% 30%, 100% 100%, 0 100%);
    transform:translateY(80px) scale(0.9);
    opacity:0;
  }
}
@keyframes swordSlice{
  0%, 45%{
    left:-220px;
    opacity:0;
  }
  48%{
    left:-20px;
    opacity:1;
  }
  62%{
    left:100%;
    opacity:1;
  }
  65%{
    left:calc(100% + 50px);
    opacity:0;
  }
  100%{
    left:calc(100% + 50px);
    opacity:0;
  }
}
@keyframes cardExit{
  0%{transform:translateX(0);opacity:1}
  100%{transform:translateX(100vw);opacity:0}
}
@keyframes cardFlipExit{
  0%{transform:rotateY(0deg)}
  100%{transform:rotateY(270deg)}
}
@keyframes godpack{
  0%,100%{box-shadow:0 0 20px rgba(255,215,0,0.5),0 0 40px rgba(255,215,0,0.3)}
  50%{box-shadow:0 0 40px rgba(255,215,0,0.9),0 0 80px rgba(255,215,0,0.5)}
}
.godpack{animation:godpack 1s ease-in-out infinite;border:3px solid gold !important}
.bonus-glow{position:absolute;inset:-10px;background:radial-gradient(circle,rgba(255,107,107,0.4),transparent 70%);border-radius:inherit;z-index:0;animation:pulseGlow 2s ease-in-out infinite;pointer-events:none}
@keyframes pulseGlow{
  0%,100%{opacity:0.5;transform:scale(1)}
  50%{opacity:1;transform:scale(1.1)}
}

#homeScreen{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:60vh;padding:2rem;position:relative}
.packImage{position:relative;width:clamp(250px,40vw,350px);height:clamp(400px,64vw,560px);margin:2rem auto;cursor:pointer;transition:transform .2s;background:linear-gradient(145deg,#2a2a3e,#1a1a2e);border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.5);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:2rem;gap:1.5rem;border:3px solid rgba(79,172,254,0.3);overflow:visible}
.packImage:hover{transform:scale(1.05)}
.packImage.ripping{animation:ripOpen 0.8s ease-out forwards;position:relative;overflow:visible !important}
.packImage.ripping::before{
  content:'';
  position:absolute;
  top:32.5%;
  left:-10%;
  width:200px;
  height:6px;
  background:linear-gradient(90deg, 
    transparent 0%, 
    rgba(79,172,254,0.3) 20%,
    rgba(79,172,254,0.6) 40%,
    rgba(79,172,254,0.9) 60%,
    rgba(255,255,255,1) 80%,
    rgba(255,255,255,1) 100%);
  box-shadow:
    0 0 15px 5px rgba(255,255,255,0.8),
    0 0 25px 8px rgba(79,172,254,0.8),
    0 0 35px 10px rgba(79,172,254,0.6);
  transform:rotate(-2.86deg);
  transform-origin:right center;
  z-index:1000;
  animation:swordSlice 0.8s ease-in forwards;
  pointer-events:none;
  border-radius:3px;
}
.packImage.ripping::after{
  content:'';
  position:absolute;
  inset:0;
  background:inherit;
  border-radius:inherit;
  border:inherit;
  animation:ripOpenBottom 0.8s ease-out forwards;
  z-index:1;
}
.packLogo{width:80%;max-width:200px;height:auto;object-fit:contain;filter:drop-shadow(0 5px 15px rgba(79,172,254,0.6))}
.packIcon{width:clamp(60px,15vw,100px);height:clamp(60px,15vw,100px);object-fit:contain;filter:drop-shadow(0 5px 15px rgba(79,172,254,0.4))}
.packBg{position:absolute;inset:0;background:radial-gradient(circle at center,rgba(79,172,254,0.1),transparent);border-radius:20px;z-index:0}
.packContent{position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;gap:1.5rem}
.setDropdown{position:fixed;top:clamp(70px,15vw,90px);left:50%;transform:translateX(-50%);z-index:100;background:rgba(0,0,0,.8);padding:0.5rem;border-radius:10px;backdrop-filter:blur(10px)}
.navButtons{display:flex;gap:1rem;margin-top:1rem;flex-wrap:wrap;justify-content:center}

#packModal,#cardViewModal{position:fixed;inset:0;background:rgba(0,0,0,.95);display:none;align-items:center;justify-content:center;z-index:1000;padding:clamp(0.5rem,2vw,1rem);flex-direction:column}
.singleCardView{display:flex;align-items:center;justify-content:center;width:100%;height:100%;cursor:pointer;perspective:1000px}
.singleCardView .card{width:clamp(250px,60vw,400px);max-width:90vw;box-shadow:0 30px 80px rgba(0,0,0,0.8)}
#cardViewModal .card{border:none !important}
#cardViewModal .count,
#cardViewModal .flip-indicator{display:none !important}
.allCardsView{display:none}
.packCards{display:flex;gap:clamp(0.5rem,2vw,1rem);flex-wrap:wrap;justify-content:center;max-width:100%;align-items:center}
.packCards .card{width:clamp(100px,25vw,180px);max-width:180px}
#collectionView{display:none}

@media (max-width:768px){
  .packCards .card{width:clamp(120px,35vw,160px)}
  .packImage{width:clamp(220px,50vw,300px);height:clamp(352px,80vw,480px)}
  .packLogo{width:75%}
  .packIcon{width:clamp(50px,12vw,80px);height:clamp(50px,12vw,80px)}
}
@media (max-width:480px){
  header{flex-direction:column;text-align:center}
  .packCards{gap:0.75rem}
  .packCards .card{width:clamp(100px,40vw,140px)}
  .navButtons{gap:0.5rem}
}
</style>
</head>
<body>
<header>
  <h1>MTG Pocket</h1>
</header>

<div class="setDropdown">
  <label style="font-size:0.85rem">Set: <select id="setSelect"></select></label>
</div>

<div id="homeScreen">
  <div class="packImage" id="packImage">
    <div class="packBg"></div>
    <div class="packContent">
      <img src="" alt="Set Logo" id="packLogo" class="packLogo">
      <img src="" alt="Set Icon" id="packIcon" class="packIcon">
    </div>
  </div>
  <button id="openPackHome" style="font-size:1.2rem;padding:1rem 2rem">Open Pack (<span id="packCost">6</span>/<span id="points">0</span>)</button>
  <div style="margin-top:1rem;font-size:0.9rem" id="countdown">Next point in: --:--</div>
  <div class="navButtons">
    <button id="viewCollection">View Collection</button>
  </div>
  <div style="margin-top:2rem;position:relative">
    <button id="devToggle" style="padding:0.5rem;font-size:0.9rem;background:rgba(255,255,255,0.1)">üõ†Ô∏è Dev</button>
    <div id="devPanel" style="display:none;position:absolute;bottom:100%;left:50%;transform:translateX(-50%);margin-bottom:0.5rem;background:rgba(0,0,0,0.9);padding:1rem;border-radius:10px;border:1px solid #333;min-width:300px;z-index:100">
      <div style="margin-bottom:0.75rem">
        <label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer">
          <input type="checkbox" id="freeMode"> 
          <span>Free Packs</span>
        </label>
      </div>
      <div style="display:flex;gap:0.5rem;align-items:center;margin-bottom:0.75rem">
        <input type="text" id="collectorInput" placeholder="Collector #" style="flex:1;padding:0.5rem;background:#222;border:1px solid #444;border-radius:6px;color:#fff;font-size:0.9rem">
        <button id="addCardBtn" style="padding:0.5rem 1rem;font-size:0.9rem">Add Card</button>
      </div>
      <div style="display:flex;gap:0.5rem;flex-direction:column">
        <button id="testGlareBtn" style="padding:0.5rem 1rem;font-size:0.9rem;width:100%">‚ú® Test Glare (Manual)</button>
        <button id="testLibraryBtn" style="padding:0.5rem 1rem;font-size:0.9rem;width:100%">üé¥ Test Glare (Library)</button>
      </div>
    </div>
  </div>
</div>

<div id="collectionView">
  <div class="controls">
    <button id="backHome">‚Üê Back to Home</button>
    <div style="margin-left:auto;font-size:1rem;font-weight:600">Total Cards: <span id="totalCards">0</span></div>
  </div>
  <div class="stats" id="stats"></div>
  <div id="collection" class="cards"></div>
</div>

<div id="packModal"></div>
<div id="cardViewModal"></div>

<script>
const PACK_COST=6,INTERVAL=3600000,FULLART_BONUS_CHANCE=0.10,GODPACK_CHANCE=0.015,MASTERPIECE_CHANCE=0.25;
const MTG_CARD_BACK='https://files.mtg.wiki/Magic_card_back.jpg';
let data=JSON.parse(localStorage.getItem('mtgPocket'))||{points:0,last:Date.now(),cards:{},lastPack:null};
let allCards=[],fullArtCards=[],masterpieceCards=[],storySpotlightCards=[],currentSet=null,setSize=0,activeRarity='all',setData={};

function migrateData(){
 Object.keys(data.cards).forEach(setCode=>{
  Object.keys(data.cards[setCode]).forEach(cardId=>{
   const card=data.cards[setCode][cardId];
   if(card.fullart===undefined){card.fullart=cardId.endsWith('_fullart')}
   if(card.backImg===undefined){card.backImg=MTG_CARD_BACK}
  });
 });
 save();
}
migrateData();

function save(){localStorage.setItem('mtgPocket',JSON.stringify(data))}

async function fetchAllPages(url){
 let allData=[];
 let nextUrl=url;
 while(nextUrl){
  const res=await fetch(nextUrl);
  const json=await res.json();
  allData.push(...json.data);
  nextUrl=json.next_page||null;
  if(nextUrl){
   console.log('Fetching next page:', nextUrl);
   await new Promise(resolve=>setTimeout(resolve,100)); // Small delay to respect rate limits
  }
 }
 return allData;
}

function enableTilt(el){
 el.onmousemove=e=>{const r=el.getBoundingClientRect();const x=(e.clientX-r.left)/r.width-.5;const y=(e.clientY-r.top)/r.height-.5;el.style.transform=`perspective(800px) rotateX(${-y*15}deg) rotateY(${x*15}deg) scale(1.05)`};
 el.onmouseleave=()=>el.style.transform='';
 el.ontouchmove=e=>{const t=e.touches[0];const r=el.getBoundingClientRect();const x=(t.clientX-r.left)/r.width-.5;const y=(t.clientY-r.top)/r.height-.5;el.style.transform=`perspective(800px) rotateX(${-y*15}deg) rotateY(${x*15}deg) scale(1.05)`};
 el.ontouchend=()=>el.style.transform='';
}

async function loadSets(){
 const allData=await fetchAllPages('https://api.scryfall.com/sets');
 let sets=allData.filter(s=>s.released_at&&s.card_count>100&&s.icon_svg_uri&&!s.parent_set_code&&!s.name.toLowerCase().includes('jumpstart')&&!s.name.toLowerCase().includes('promo')&&!/Commander\s*$/i.test(s.name));
 sets.sort((a,b)=>new Date(b.released_at)-new Date(a.released_at));
 const sel=document.getElementById('setSelect');
 sel.innerHTML='';
 sets.forEach(s=>{const o=document.createElement('option');o.value=s.code;o.textContent=s.name;sel.appendChild(o);setData[s.code]={name:s.name,icon:s.icon_svg_uri}});
 
 allData.forEach(s=>{if(!setData[s.code]){setData[s.code]={name:s.name,icon:s.icon_svg_uri,parent:s.parent_set_code,type:s.set_type}}});
 
 currentSet=data.lastPack||sel.value;
 sel.value=currentSet;
 loadSet();
}

async function loadSet(){
 console.log('=== LOAD SET DEBUG ===');
 
 const allData=await fetchAllPages(`https://api.scryfall.com/cards/search?q=set:${currentSet}+game:paper&unique=cards`);
 console.log('Total cards from API (all pages):', allData.length);
 
 // Include both single-faced cards AND multi-faced cards
 allCards=allData.filter(c=>{
  const hasRarity=['common','uncommon','rare','mythic'].includes(c.rarity);
  if(!hasRarity) return false;
  
  const hasTopLevelImage=c.image_uris;
  const hasCardFaceImage=c.card_faces&&c.card_faces.length>0&&c.card_faces[0].image_uris;
  
  return hasTopLevelImage||hasCardFaceImage;
 });
 
 console.log('Filtered allCards:', allCards.length);
 
 allCards.sort((a,b)=>{
  const numA=parseInt(a.collector_number)||0;
  const numB=parseInt(b.collector_number)||0;
  return numA-numB;
 });
 
 try{
  const faData=await fetchAllPages(`https://api.scryfall.com/cards/search?q=set:${currentSet}+game:paper+(is:extended+OR+is:fullart)&unique=cards`);
  fullArtCards=faData.filter(c=>c.image_uris||c.card_faces);
  console.log('Full art cards:', fullArtCards.length);
 }catch(e){fullArtCards=[]}
 
 masterpieceCards=[];
 const allSetCodes=Object.keys(setData);
 const childMasterpieceSets=allSetCodes.filter(code=>setData[code].parent===currentSet&&setData[code].type==='masterpiece');
 if(childMasterpieceSets.length>0){
  for(const childCode of childMasterpieceSets){
   try{
    const mpData=await fetchAllPages(`https://api.scryfall.com/cards/search?q=set:${childCode}+game:paper&unique=cards`);
    masterpieceCards.push(...mpData.filter(c=>c.image_uris||c.card_faces));
   }catch(e){}
  }
 }
 console.log('Masterpiece cards:', masterpieceCards.length);
 
 storySpotlightCards=[];
 try{
  const ssData=await fetchAllPages(`https://api.scryfall.com/cards/search?q=set:${currentSet}+is:spotlight&unique=cards`);
  storySpotlightCards=ssData.filter(c=>c.image_uris||c.card_faces);
  storySpotlightCards.sort((a,b)=>{
   const numA=parseInt(a.collector_number)||0;
   const numB=parseInt(b.collector_number)||0;
   return numA-numB;
  });
  console.log('Story spotlight cards:', storySpotlightCards.length);
 }catch(e){}
 
 setSize=allCards.length;
 console.log('Final setSize:', setSize);
 console.log('=== END LOAD SET DEBUG ===');
 updatePackImage();
 render();
 updateStats();
}

function updatePackImage(){
 const logo=document.getElementById('packLogo');
 const icon=document.getElementById('packIcon');
 logo.src=`https://www.mtgpics.com/graph/sets/logos_big/${currentSet}.png`;
 logo.onerror=()=>{logo.style.display='none'};
 logo.onload=()=>{logo.style.display='block'};
 if(setData[currentSet]&&setData[currentSet].icon){icon.src=setData[currentSet].icon;icon.style.display='block'}else{icon.style.display='none'}
}

function roll(){let r=Math.random()*100;if(r<1)return'mythic';if(r<10)return'rare';if(r<30)return'uncommon';return'common'}

function tick(){
 const now=Date.now();
 const diff=now-data.last;
 const h=Math.floor(diff/INTERVAL);
 if(h>0){data.points+=h;data.last+=h*INTERVAL;save()}
 const rem=INTERVAL-(now-data.last);
 const m=Math.floor(rem/60000),s=Math.floor(rem%60000/1000);
 document.getElementById('countdown').textContent=`Next point in: ${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
 update();
}

async function openPack(){
 const free=document.getElementById('freeMode').checked;
 if(!free&&data.points<PACK_COST) return;
 const packImg=document.getElementById('packImage');
 packImg.classList.add('ripping');
 await new Promise(resolve=>setTimeout(resolve,800));
 packImg.classList.remove('ripping');
 if(!free) data.points-=PACK_COST;
 data.cards[currentSet]=data.cards[currentSet]||{};
 data.lastPack=currentSet;
 const isGodPack=Math.random()<GODPACK_CHANCE&&fullArtCards.length>0;
 let pack=[];
 
 console.log('=== OPEN PACK DEBUG ===');
 
 function getCardImages(card){
  console.log('Getting images for:', card.name);
  console.log('Has image_uris:', !!card.image_uris);
  console.log('Has card_faces:', !!card.card_faces);
  
  if(card.image_uris){
   const front=card.image_uris.normal;
   const back=card.card_faces&&card.card_faces.length>1&&card.card_faces[1].image_uris?card.card_faces[1].image_uris.normal:MTG_CARD_BACK;
   console.log('Single-face - Front:', front, 'Back:', back);
   return {front,back};
  }else if(card.card_faces&&card.card_faces.length>0){
   const front=card.card_faces[0].image_uris?card.card_faces[0].image_uris.normal:MTG_CARD_BACK;
   const back=card.card_faces.length>1&&card.card_faces[1].image_uris?card.card_faces[1].image_uris.normal:MTG_CARD_BACK;
   console.log('Multi-face - Front:', front, 'Back:', back);
   return {front,back};
  }
  console.log('ERROR: No images found!');
  return {front:MTG_CARD_BACK,back:MTG_CARD_BACK};
 }
 
 if(isGodPack){
  for(let i=0;i<5;i++){
   const card=fullArtCards[Math.floor(Math.random()*fullArtCards.length)];
   const id=card.id+'_fullart';
   const isNew=!data.cards[currentSet][id];
   const imgs=getCardImages(card);
   if(!data.cards[currentSet][id]){data.cards[currentSet][id]={name:card.name,rarity:card.rarity,img:imgs.front,backImg:imgs.back,count:0,fullart:true,collectorNum:card.collector_number}}
   data.cards[currentSet][id].count++;
   pack.push({...data.cards[currentSet][id],isNew,isGodPack:true});
  }
 }else{
  for(let i=0;i<5;i++){
   const rarity=roll();
   const pool=allCards.filter(c=>c.rarity===rarity);
   console.log('Pool for', rarity, ':', pool.length);
   const card=pool[Math.floor(Math.random()*pool.length)];
   const id=card.id;
   const isNew=!data.cards[currentSet][id];
   
   const isSpotlight=storySpotlightCards.some(sc=>sc.id===card.id);
   const imgs=getCardImages(card);
   
   if(!data.cards[currentSet][id]){data.cards[currentSet][id]={name:card.name,rarity:card.rarity,img:imgs.front,backImg:imgs.back,count:0,fullart:false,spotlight:isSpotlight,collectorNum:card.collector_number}}
   data.cards[currentSet][id].count++;
   pack.push({...data.cards[currentSet][id],isNew});
  }
  
  let got6thCard=false;
  if(Math.random()<FULLART_BONUS_CHANCE&&fullArtCards.length>0){
   const card=fullArtCards[Math.floor(Math.random()*fullArtCards.length)];
   const id=card.id+'_fullart';
   const isNew=!data.cards[currentSet][id];
   const imgs=getCardImages(card);
   if(!data.cards[currentSet][id]){data.cards[currentSet][id]={name:card.name,rarity:card.rarity,img:imgs.front,backImg:imgs.back,count:0,fullart:true,collectorNum:card.collector_number}}
   data.cards[currentSet][id].count++;
   pack.push({...data.cards[currentSet][id],isNew,isBonus:true});
   got6thCard=true;
  }
  
  if(got6thCard && Math.random()<MASTERPIECE_CHANCE&&masterpieceCards.length>0){
   const card=masterpieceCards[Math.floor(Math.random()*masterpieceCards.length)];
   const id=card.id+'_masterpiece';
   const isNew=!data.cards[currentSet][id];
   const imgs=getCardImages(card);
   if(!data.cards[currentSet][id]){data.cards[currentSet][id]={name:card.name,rarity:card.rarity,img:imgs.front,backImg:imgs.back,count:0,masterpiece:true,collectorNum:card.collector_number}}
   data.cards[currentSet][id].count++;
   pack.push({...data.cards[currentSet][id],isNew,isSecret:true});
  }
 }
 
 console.log('Pack contents:', pack);
 console.log('=== END OPEN PACK DEBUG ===');
 
 save();
 updatePackImage();
 showPack(pack,isGodPack);
 update();
}

function showPack(pack,isGodPack){
 const m=document.getElementById('packModal');
 m.style.display='flex';
 if(isGodPack){m.innerHTML='<div style="text-align:center;margin-bottom:1rem"><h2 style="color:#ffd700;font-size:2rem;text-shadow:0 0 20px rgba(255,215,0,0.8)">üåü GOD PACK! üåü</h2></div><div class="singleCardView"></div><div class="allCardsView"><div class="packCards"></div></div>'}else{m.innerHTML='<div class="singleCardView"></div><div class="allCardsView"><div class="packCards"></div></div>'}
 const singleView=m.querySelector('.singleCardView');
 const allView=m.querySelector('.allCardsView');
 const allCardsContainer=m.querySelector('.packCards');
 const regularCards=pack.filter(card=>!card.isBonus&&!card.isSecret);
 const bonusCards=pack.filter(card=>card.isBonus);
 const secretCards=pack.filter(card=>card.isSecret);
 const allPackCards=[...regularCards,...bonusCards,...secretCards];
 let currentIndex=0;
 let allCardsShown=false;
 function closeModal(){m.style.display='none';m.innerHTML='';render()}
 function showNextCard(){
  if(currentIndex<allPackCards.length){
   const card=allPackCards[currentIndex];
   const isBonus=card.isBonus;
   const isSecret=card.isSecret;
   if(singleView.children.length>0){
    const existingCard=singleView.children[0];
    const existingInner=existingCard.querySelector('.card-inner');
    // Add exiting class to remove border
    existingCard.classList.add('exiting');
    existingCard.style.animation='cardExit 0.5s ease-in forwards';
    if(existingInner){
     existingInner.classList.add('no-transition');
     existingInner.style.animation='cardFlipExit 0.5s ease-in forwards';
    }
    setTimeout(()=>{showCardInternal(card,isBonus,isSecret)},500);
   }else{
    showCardInternal(card,isBonus,isSecret);
   }
  }else{
   if(singleView.children.length>0){
    const existingCard=singleView.children[0];
    const existingInner=existingCard.querySelector('.card-inner');
    // Add exiting class to remove border
    existingCard.classList.add('exiting');
    existingCard.style.animation='cardExit 0.5s ease-in forwards';
    if(existingInner){
     existingInner.classList.add('no-transition');
     existingInner.style.animation='cardFlipExit 0.5s ease-in forwards';
    }
    setTimeout(()=>{singleView.style.display='none';allView.style.display='block';allCardsShown=true;singleView.onclick=null},500);
   }else{
    singleView.style.display='none';allView.style.display='block';allCardsShown=true;singleView.onclick=null;
   }
  }
 }
 function showCardInternal(card,isBonus,isSecret){
  singleView.innerHTML='';
  
  const cardDiv=document.createElement('div');
  cardDiv.className=`card rarity-${card.rarity}`;
  cardDiv.style.cssText='width:100%;max-width:400px';
  
  const innerDiv=document.createElement('div');
  innerDiv.className='card-inner';
  
  const frontDiv=document.createElement('div');
  frontDiv.className='card-front';
  const frontImg=document.createElement('img');
  frontImg.src=card.img;
  frontImg.alt=card.name;
  frontDiv.appendChild(frontImg);
  
  const backDiv=document.createElement('div');
  backDiv.className='card-back';
  const backImg=document.createElement('img');
  backImg.src=card.backImg||MTG_CARD_BACK;
  backImg.alt='Card back';
  backDiv.appendChild(backImg);
  
  const countDiv=document.createElement('div');
  countDiv.className='count';
  countDiv.textContent=`x${card.count}`;
  
  innerDiv.appendChild(frontDiv);
  innerDiv.appendChild(backDiv);
  innerDiv.appendChild(countDiv);
  
  // Add flip indicator if card has a different back
  if(card.backImg && card.backImg!==MTG_CARD_BACK){
   const flipDiv=document.createElement('div');
   flipDiv.className='flip-indicator';
   flipDiv.textContent='üîÑ';
   innerDiv.appendChild(flipDiv);
  }
  
  cardDiv.appendChild(innerDiv);
  
  if(card.isNew) cardDiv.classList.add('new-card');
  if(card.spotlight===true) cardDiv.classList.add('story-card');
  if(card.isGodPack) cardDiv.classList.add('godpack');
  
  if(card.masterpiece===true || isSecret===true){
   cardDiv.classList.add('godpack');
   cardDiv.style.filter='brightness(1.5) drop-shadow(0 0 30px rgba(155,89,182,0.9))';
   const glowDiv=document.createElement('div');
   glowDiv.className='bonus-glow';
   glowDiv.style.background='radial-gradient(circle,rgba(155,89,182,0.6),transparent 70%)';
   glowDiv.style.pointerEvents='none';
   cardDiv.insertBefore(glowDiv,cardDiv.firstChild);
  }else if(isBonus===true){
   cardDiv.classList.add('godpack');
   cardDiv.style.filter='brightness(1.3) drop-shadow(0 0 20px rgba(255,107,107,0.8))';
   const glowDiv=document.createElement('div');
   glowDiv.className='bonus-glow';
   glowDiv.style.pointerEvents='none';
   cardDiv.insertBefore(glowDiv,cardDiv.firstChild);
  }
  
  singleView.appendChild(cardDiv);
  
  const smallCard=cardEl(card,false);
  if(card.isNew) smallCard.classList.add('new-card');
  if(card.spotlight===true) smallCard.classList.add('story-card');
  if(card.isGodPack) smallCard.classList.add('godpack');
  
  if(card.masterpiece===true || isSecret===true){
   smallCard.classList.add('godpack');
   const glowDiv=document.createElement('div');
   glowDiv.className='bonus-glow';
   glowDiv.style.background='radial-gradient(circle,rgba(155,89,182,0.6),transparent 70%)';
   glowDiv.style.pointerEvents='none';
   smallCard.insertBefore(glowDiv,smallCard.firstChild);
  }else if(isBonus===true){
   smallCard.classList.add('godpack');
   addBonusGlow(smallCard);
  }
  
  allCardsContainer.appendChild(smallCard);
  currentIndex++;
 }
 showNextCard();
 singleView.onclick=showNextCard;
 m.onclick=(e)=>{if(allCardsShown&&e.target===m){closeModal()}};
 allView.onclick=(e)=>{if(e.target===allView||e.target.closest('.packCards')===allCardsContainer){closeModal()}};
}

function addBonusGlow(cardElement){const glowDiv=document.createElement('div');glowDiv.className='bonus-glow';cardElement.insertBefore(glowDiv,cardElement.firstChild)}

function cardEl(card,isRevealing){
 const cardDiv=document.createElement('div');
 cardDiv.className=`card rarity-${card.rarity}`;
 
 const innerDiv=document.createElement('div');
 innerDiv.className='card-inner';
 
 const frontDiv=document.createElement('div');
 frontDiv.className='card-front';
 const frontImg=document.createElement('img');
 frontImg.src=card.img;
 frontImg.alt=card.name;
 frontDiv.appendChild(frontImg);
 
 const backDiv=document.createElement('div');
 backDiv.className='card-back';
 const backImg=document.createElement('img');
 backImg.src=card.backImg||MTG_CARD_BACK;
 backImg.alt='Card back';
 backDiv.appendChild(backImg);
 
 const countDiv=document.createElement('div');
 countDiv.className='count';
 countDiv.textContent=`x${card.count}`;
 
 innerDiv.appendChild(frontDiv);
 innerDiv.appendChild(backDiv);
 innerDiv.appendChild(countDiv);
 
 // Add flip indicator if card has a different back (not standard MTG back)
 if(card.backImg && card.backImg!==MTG_CARD_BACK){
  const flipDiv=document.createElement('div');
  flipDiv.className='flip-indicator';
  flipDiv.textContent='üîÑ';
  innerDiv.appendChild(flipDiv);
 }
 
 cardDiv.appendChild(innerDiv);
 
 if(!isRevealing){
  enableTilt(cardDiv);
  cardDiv.onclick=e=>{
   e.stopPropagation();
   showCard(card);
  };
 }
 
 return cardDiv;
}

function showCard(card){
 const modal=document.getElementById('cardViewModal');
 modal.style.display='flex';
 modal.innerHTML='';
 
 const container=document.createElement('div');
 container.style.cssText='display:flex;flex-direction:column;align-items:center;gap:1.5rem;max-width:90vw';
 
 const perspectiveDiv=document.createElement('div');
 perspectiveDiv.style.cssText='perspective:1000px;max-width:400px;width:clamp(250px,60vw,400px)';
 
 const cardDiv=document.createElement('div');
 cardDiv.className=`card rarity-${card.rarity}`;
 
 const innerDiv=document.createElement('div');
 innerDiv.className='card-inner';
 
 const frontDiv=document.createElement('div');
 frontDiv.className='card-front';
 const frontImg=document.createElement('img');
 frontImg.src=card.img;
 frontImg.alt=card.name;
 frontDiv.appendChild(frontImg);
 
 const backDiv=document.createElement('div');
 backDiv.className='card-back';
 const backImg=document.createElement('img');
 backImg.src=card.backImg||MTG_CARD_BACK;
 backImg.alt='Card back';
 backDiv.appendChild(backImg);
 
 const countDiv=document.createElement('div');
 countDiv.className='count';
 countDiv.textContent=`x${card.count}`;
 
 innerDiv.appendChild(frontDiv);
 innerDiv.appendChild(backDiv);
 innerDiv.appendChild(countDiv);
 cardDiv.appendChild(innerDiv);
 perspectiveDiv.appendChild(cardDiv);
 
 const flipBtn=document.createElement('button');
 flipBtn.textContent='üîÑ Flip Card';
 flipBtn.style.cssText='padding:0.75rem 1.5rem;font-size:1rem';
 
 flipBtn.onclick=()=>{
  const current=innerDiv.style.transform||'rotateY(0deg)';
  const isFlipped=current.includes('180');
  innerDiv.style.transform=isFlipped?'rotateY(0deg)':'rotateY(180deg)';
 };
 
 innerDiv.onclick=(e)=>{
  if(e.target.tagName!=='IMG'){return;}
  const current=innerDiv.style.transform||'rotateY(0deg)';
  const isFlipped=current.includes('180');
  innerDiv.style.transform=isFlipped?'rotateY(0deg)':'rotateY(180deg)';
 };
 
 container.appendChild(perspectiveDiv);
 container.appendChild(flipBtn);
 modal.appendChild(container);
 
 modal.onclick=(e)=>{
  if(e.target===modal){
   modal.style.display='none';
  }
 };
}

function render(){
 const col=document.getElementById('collection');
 col.innerHTML='';
 if(!allCards.length){return}
 
 const owned=data.cards[currentSet]||{};
 
 const ownedByName={};
 Object.values(owned).forEach(c=>{
  if(!ownedByName[c.name]){ownedByName[c.name]=[]}
  ownedByName[c.name].push(c);
 });
 
 if(activeRarity==='secrets'){
  const masterpieceList=Object.values(owned).filter(c=>c.masterpiece===true);
  masterpieceList.sort((a,b)=>{
   const numA=parseInt(a.collectorNum)||0;
   const numB=parseInt(b.collectorNum)||0;
   return numA-numB;
  });
  masterpieceList.forEach(c=>{col.appendChild(cardEl(c))});
  
 }else if(activeRarity==='spotlight'){
  storySpotlightCards.forEach((card)=>{
   const variants=ownedByName[card.name]||[];
   const ownedSpotlight=variants.find(v=>v.spotlight===true);
   if(ownedSpotlight){
    col.appendChild(cardEl(ownedSpotlight));
   }else{
    const placeholder=document.createElement('div');
    placeholder.className='card-placeholder';
    placeholder.textContent=`#${card.collector_number}`;
    col.appendChild(placeholder);
   }
  });
  
 }else if(activeRarity==='fullart'){
  const fullartList=Object.values(owned).filter(c=>c.fullart===true);
  fullartList.sort((a,b)=>{
   const numA=parseInt(a.collectorNum)||0;
   const numB=parseInt(b.collectorNum)||0;
   return numA-numB;
  });
  fullartList.forEach(c=>{col.appendChild(cardEl(c))});
  
 }else if(activeRarity==='all'){
  allCards.forEach((card)=>{
   const variants=ownedByName[card.name]||[];
   const regularCard=variants.find(v=>v.fullart===false);
   if(regularCard){
    col.appendChild(cardEl(regularCard));
   }else{
    const placeholder=document.createElement('div');
    placeholder.className='card-placeholder';
    placeholder.textContent=`#${card.collector_number}`;
    col.appendChild(placeholder);
   }
  });
  
  const fullartList=Object.values(owned).filter(c=>c.fullart===true);
  fullartList.sort((a,b)=>{
   const numA=parseInt(a.collectorNum)||0;
   const numB=parseInt(b.collectorNum)||0;
   return numA-numB;
  });
  fullartList.forEach(c=>{col.appendChild(cardEl(c))});
  
  const spotlightList=Object.values(owned).filter(c=>c.spotlight===true);
  spotlightList.sort((a,b)=>{
   const numA=parseInt(a.collectorNum)||0;
   const numB=parseInt(b.collectorNum)||0;
   return numA-numB;
  });
  spotlightList.forEach(c=>{col.appendChild(cardEl(c))});
  
  const masterpieceList=Object.values(owned).filter(c=>c.masterpiece===true);
  masterpieceList.sort((a,b)=>{
   const numA=parseInt(a.collectorNum)||0;
   const numB=parseInt(b.collectorNum)||0;
   return numA-numB;
  });
  masterpieceList.forEach(c=>{col.appendChild(cardEl(c))});
  
 }else{
  allCards.forEach((card)=>{
   if(card.rarity!==activeRarity){return}
   const variants=ownedByName[card.name]||[];
   const regularCard=variants.find(v=>v.fullart===false);
   if(regularCard){
    col.appendChild(cardEl(regularCard));
   }else{
    const placeholder=document.createElement('div');
    placeholder.className='card-placeholder';
    placeholder.textContent=`#${card.collector_number}`;
    col.appendChild(placeholder);
   }
  });
 }
}

function updateStats(){
 const statsEl=document.getElementById('stats');
 if(!currentSet){return}
 const owned=data.cards[currentSet]||{};
 const uniqueOwned={common:0,uncommon:0,rare:0,mythic:0};
 const ownedNames=new Set();
 Object.values(owned).forEach(c=>{
  if(c.fullart===false && !ownedNames.has(c.name)){uniqueOwned[c.rarity]++;ownedNames.add(c.name)}
 });
 const totals={common:0,uncommon:0,rare:0,mythic:0};
 allCards.forEach(c=>totals[c.rarity]++);
 const fullartTotal=fullArtCards.length;
 const fullartOwned=Object.values(owned).filter(c=>c.fullart===true).length;
 const masterpieceOwned=Object.values(owned).filter(c=>c.masterpiece===true).length;
 const storySpotlightOwned=Object.values(owned).filter(c=>c.spotlight===true).length;
 const storySpotlightTotal=storySpotlightCards.length;
 const totalCollected=ownedNames.size+fullartOwned+storySpotlightOwned+masterpieceOwned;
 
 // Update total cards counter
 document.getElementById('totalCards').textContent=totalCollected;
 
 statsEl.innerHTML=`<div class='statBox' data-rarity='all'><b>All Cards</b> ${totalCollected}</div>${['common','uncommon','rare','mythic'].map(r=>`<div class='statBox' data-rarity='${r}'><b>${r.toUpperCase()}</b> ${uniqueOwned[r]}/${totals[r]}<div class='progress'><div style='width:${totals[r]?uniqueOwned[r]/totals[r]*100:0}%'></div></div></div>`).join('')}<div class='statBox' data-rarity='fullart' style='background:linear-gradient(135deg,#2a2a3e,#1a1a2e);border:2px solid #ff6b6b'><b>FULL ART</b> ${fullartOwned}/${fullartTotal}<div class='progress'><div style='width:${fullartTotal?fullartOwned/fullartTotal*100:0}%;background:linear-gradient(90deg,#ff6b6b,#ee5a6f)'></div></div></div>${storySpotlightTotal>0?`<div class='statBox' data-rarity='spotlight' style='background:linear-gradient(135deg,#2a3a4e,#1a2a3e);border:2px solid #3498db'><b>STORY SPOTLIGHT</b> ${storySpotlightOwned}/${storySpotlightTotal}<div class='progress'><div style='width:${storySpotlightTotal?storySpotlightOwned/storySpotlightTotal*100:0}%;background:linear-gradient(90deg,#3498db,#2980b9)'></div></div></div>`:''}${masterpieceCards.length>0?`<div class='statBox' data-rarity='secrets' style='background:linear-gradient(135deg,#3a1a5e,#1a0a2e);border:2px solid #9b59b6'><b>SECRETS</b> ${masterpieceOwned}</div>`:''}`;
 statsEl.querySelectorAll('.statBox').forEach(box=>{box.onclick=()=>{activeRarity=box.dataset.rarity;statsEl.querySelectorAll('.statBox').forEach(b=>b.classList.remove('active'));box.classList.add('active');render()}});
}

function update(){
 const freeMode=document.getElementById('freeMode').checked;
 const btn=document.getElementById('openPackHome');
 const costSpan=document.getElementById('packCost');
 const pointsSpan=document.getElementById('points');
 
 if(freeMode){
  costSpan.textContent='0';
  pointsSpan.textContent='‚àû';
  btn.style.background='linear-gradient(135deg,#ff6b6b,#ee5a6f)';
  btn.disabled=false;
 }else{
  costSpan.textContent=PACK_COST;
  pointsSpan.textContent=data.points;
  btn.style.background='linear-gradient(135deg,#4facfe,#00f2fe)';
  btn.disabled=data.points<PACK_COST;
 }
}

function showHome(){
 document.getElementById('homeScreen').style.display='flex';
 document.getElementById('collectionView').style.display='none';
 document.querySelector('.setDropdown').style.display='block';
}
function showCollection(){
 document.getElementById('homeScreen').style.display='none';
 document.getElementById('collectionView').style.display='block';
 document.querySelector('.setDropdown').style.display='none';
 render();
 updateStats();
}

document.getElementById('openPackHome').onclick=openPack;
document.getElementById('packImage').onclick=openPack;
document.getElementById('viewCollection').onclick=showCollection;
document.getElementById('backHome').onclick=showHome;
document.getElementById('setSelect').onchange=e=>{currentSet=e.target.value;loadSet()};
document.getElementById('freeMode').onchange=update;

document.getElementById('devToggle').onclick=()=>{
 const panel=document.getElementById('devPanel');
 panel.style.display=panel.style.display==='none'?'block':'none';
};

document.getElementById('testGlareBtn').onclick=async()=>{
 const modal=document.getElementById('cardViewModal');
 modal.style.display='flex';
 modal.innerHTML='<div style="padding:2rem">Loading card...</div>';
 
 // Get a random card from current set
 let testCardData=null;
 if(allCards.length>0){
  const randomCard=allCards[Math.floor(Math.random()*allCards.length)];
  testCardData={
   front:randomCard.image_uris?randomCard.image_uris.normal:randomCard.card_faces?.[0]?.image_uris?.normal,
   back:randomCard.card_faces?.[1]?.image_uris?.normal||MTG_CARD_BACK
  };
 }else{
  // Fallback if no cards loaded
  testCardData={
   front:MTG_CARD_BACK,
   back:MTG_CARD_BACK
  };
 }
 
 modal.innerHTML='';
 
 const container=document.createElement('div');
 container.style.cssText='display:flex;flex-direction:column;align-items:center;gap:1.5rem';
 
 const perspectiveDiv=document.createElement('div');
 perspectiveDiv.style.cssText='perspective:1000px;width:300px;height:420px';
 
 const testCard=document.createElement('div');
 testCard.style.cssText='width:100%;height:100%;position:relative;transform-style:preserve-3d;transition:transform 0.1s ease-out;border-radius:12px';
 
 const innerContainer=document.createElement('div');
 innerContainer.style.cssText='width:100%;height:100%;position:relative;transform-style:preserve-3d;transition:transform 0.6s';
 
 // Front face
 const front=document.createElement('div');
 front.style.cssText='position:absolute;width:100%;height:100%;backface-visibility:hidden;border-radius:12px;overflow:hidden';
 const frontImg=document.createElement('img');
 frontImg.src=testCardData.front;
 frontImg.style.cssText='width:100%;height:100%;object-fit:cover';
 front.appendChild(frontImg);
 
 // Back face
 const back=document.createElement('div');
 back.style.cssText='position:absolute;width:100%;height:100%;backface-visibility:hidden;border-radius:12px;transform:rotateY(180deg);overflow:hidden';
 const backImg=document.createElement('img');
 backImg.src=testCardData.back;
 backImg.style.cssText='width:100%;height:100%;object-fit:cover';
 back.appendChild(backImg);
 
 // Glare overlay on front
 const glare=document.createElement('div');
 glare.style.cssText='position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;opacity:0;transition:opacity 0.3s;overflow:hidden';
 
 const glareGradient=document.createElement('div');
 glareGradient.style.cssText='position:absolute;width:200px;height:200px;background:radial-gradient(circle at center, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0.4) 30%, transparent 70%);transform:translate(-50%, -50%);mix-blend-mode:overlay';
 glare.appendChild(glareGradient);
 front.appendChild(glare);
 
 // Glare overlay on back
 const glareBack=document.createElement('div');
 glareBack.style.cssText='position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;opacity:0;transition:opacity 0.3s;overflow:hidden';
 
 const glareGradientBack=document.createElement('div');
 glareGradientBack.style.cssText='position:absolute;width:200px;height:200px;background:radial-gradient(circle at center, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0.4) 30%, transparent 70%);transform:translate(-50%, -50%);mix-blend-mode:overlay';
 glareBack.appendChild(glareGradientBack);
 back.appendChild(glareBack);
 
 innerContainer.appendChild(front);
 innerContainer.appendChild(back);
 testCard.appendChild(innerContainer);
 perspectiveDiv.appendChild(testCard);
 
 // Track which face is showing
 let isFlipped=false;
 
 // Mouse movement handler
 testCard.onmousemove=(e)=>{
  const rect=testCard.getBoundingClientRect();
  const x=(e.clientX-rect.left)/rect.width;
  const y=(e.clientY-rect.top)/rect.height;
  
  const centerX=x-0.5;
  const centerY=y-0.5;
  
  const rotateX=-centerY*20;
  const rotateY=centerX*20;
  
  testCard.style.transform=`rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
  
  // Position glare based on which face is showing
  if(!isFlipped){
   // Front face - normal positioning
   glareGradient.style.left=`${x*100}%`;
   glareGradient.style.top=`${y*100}%`;
   glare.style.opacity='1';
   glareBack.style.opacity='0';
  }else{
   // Back face - reversed positioning (because face is rotated 180deg)
   glareGradientBack.style.left=`${(1-x)*100}%`;
   glareGradientBack.style.top=`${y*100}%`;
   glareBack.style.opacity='1';
   glare.style.opacity='0';
  }
 };
 
 testCard.onmouseleave=()=>{
  testCard.style.transform='rotateX(0deg) rotateY(0deg)';
  glare.style.opacity='0';
  glareBack.style.opacity='0';
 };
 
 // Gyroscope support for mobile
 let gyroActive=false;
 let orientationHandler=null;
 let baseOrientation={beta:0,gamma:0};
 let hasBaseOrientation=false;
 
 if(window.DeviceOrientationEvent){
  orientationHandler=(e)=>{
   if(!e.beta || !e.gamma) return;
   
   // Set base orientation on first read
   if(!hasBaseOrientation){
    baseOrientation={beta:e.beta,gamma:e.gamma};
    hasBaseOrientation=true;
    return;
   }
   
   // Calculate relative to base
   const beta=e.beta-baseOrientation.beta;
   const gamma=e.gamma-baseOrientation.gamma;
   
   const tiltX=Math.max(-1,Math.min(1,beta/45));
   const tiltY=Math.max(-1,Math.min(1,gamma/45));
   
   const rotateX=-tiltX*20;
   const rotateY=tiltY*20;
   
   testCard.style.transform=`rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
   
   // Convert tilt to glare position (normalized 0-1)
   const glareX=(tiltY+1)/2;
   const glareY=(1-tiltX)/2; // Inverted Y for natural feel
   
   if(!isFlipped){
    // Front face
    glareGradient.style.left=`${glareX*100}%`;
    glareGradient.style.top=`${glareY*100}%`;
    glare.style.opacity='1';
    glareBack.style.opacity='0';
   }else{
    // Back face - reversed X
    glareGradientBack.style.left=`${(1-glareX)*100}%`;
    glareGradientBack.style.top=`${glareY*100}%`;
    glareBack.style.opacity='1';
    glare.style.opacity='0';
   }
  };
  
  if(typeof DeviceOrientationEvent.requestPermission==='function'){
   DeviceOrientationEvent.requestPermission()
    .then(permissionState=>{
     if(permissionState==='granted'){
      gyroActive=true;
      window.addEventListener('deviceorientation',orientationHandler);
     }
    })
    .catch(console.error);
  }else if(/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)){
   gyroActive=true;
   window.addEventListener('deviceorientation',orientationHandler);
  }
 }
 
 const flipBtn=document.createElement('button');
 flipBtn.textContent='üîÑ Flip Test';
 flipBtn.style.cssText='padding:0.75rem 1.5rem;font-size:1rem';
 flipBtn.onclick=()=>{
  isFlipped=!isFlipped;
  innerContainer.style.transform=isFlipped?'rotateY(180deg)':'rotateY(0deg)';
 };
 
 const closeBtn=document.createElement('button');
 closeBtn.textContent='Close';
 closeBtn.style.cssText='padding:0.5rem 1rem;font-size:0.9rem;background:#666';
 closeBtn.onclick=()=>{
  if(gyroActive && orientationHandler){
   window.removeEventListener('deviceorientation',orientationHandler);
  }
  modal.style.display='none';
 };
 
 container.appendChild(perspectiveDiv);
 container.appendChild(flipBtn);
 container.appendChild(closeBtn);
 modal.appendChild(container);
 
 modal.onclick=(e)=>{
  if(e.target===modal){
   if(gyroActive && orientationHandler){
    window.removeEventListener('deviceorientation',orientationHandler);
   }
   modal.style.display='none';
  }
 };
};

document.getElementById('testLibraryBtn').onclick=async()=>{
 const modal=document.getElementById('cardViewModal');
 modal.style.display='flex';
 modal.innerHTML='<div style="padding:2rem">Loading card...</div>';
 
 // Get a random card from current set
 let testCardData=null;
 if(allCards.length>0){
  const randomCard=allCards[Math.floor(Math.random()*allCards.length)];
  testCardData={
   front:randomCard.image_uris?randomCard.image_uris.normal:randomCard.card_faces?.[0]?.image_uris?.normal,
   back:randomCard.card_faces?.[1]?.image_uris?.normal||MTG_CARD_BACK,
   name:randomCard.name
  };
 }else{
  testCardData={
   front:MTG_CARD_BACK,
   back:MTG_CARD_BACK,
   name:'Test Card'
  };
 }
 
 modal.innerHTML='';
 
 const container=document.createElement('div');
 container.style.cssText='display:flex;flex-direction:column;align-items:center;gap:1.5rem';
 
 // Create hover-tilt wrapper
 const hoverTilt=document.createElement('hover-tilt');
 hoverTilt.setAttribute('shadow','');
 hoverTilt.setAttribute('tilt-factor','1.2');
 hoverTilt.setAttribute('scale-factor','1.05');
 hoverTilt.style.cssText='width:300px;height:420px;border-radius:4.55%;overflow:hidden';
 
 // Inner container for flippable card
 const cardContainer=document.createElement('div');
 cardContainer.style.cssText='width:100%;height:100%;position:relative;transform-style:preserve-3d;transition:transform 0.6s';
 
 // Front face
 const front=document.createElement('div');
 front.style.cssText='position:absolute;width:100%;height:100%;backface-visibility:hidden;border-radius:inherit;overflow:hidden';
 const frontImg=document.createElement('img');
 frontImg.src=testCardData.front;
 frontImg.alt=testCardData.name;
 frontImg.style.cssText='width:100%;height:100%;object-fit:cover;display:block';
 front.appendChild(frontImg);
 
 // Back face
 const back=document.createElement('div');
 back.style.cssText='position:absolute;width:100%;height:100%;backface-visibility:hidden;border-radius:inherit;transform:rotateY(180deg);overflow:hidden';
 const backImg=document.createElement('img');
 backImg.src=testCardData.back;
 backImg.alt='Card back';
 backImg.style.cssText='width:100%;height:100%;object-fit:cover;display:block';
 back.appendChild(backImg);
 
 cardContainer.appendChild(front);
 cardContainer.appendChild(back);
 hoverTilt.appendChild(cardContainer);
 
 // Track flip state
 let isFlipped=false;
 
 const flipBtn=document.createElement('button');
 flipBtn.textContent='üîÑ Flip Card';
 flipBtn.style.cssText='padding:0.75rem 1.5rem;font-size:1rem';
 flipBtn.onclick=()=>{
  isFlipped=!isFlipped;
  cardContainer.style.transform=isFlipped?'rotateY(180deg)':'rotateY(0deg)';
 };
 
 const closeBtn=document.createElement('button');
 closeBtn.textContent='Close';
 closeBtn.style.cssText='padding:0.5rem 1rem;font-size:0.9rem;background:#666';
 closeBtn.onclick=()=>{
  modal.style.display='none';
 };
 
 container.appendChild(hoverTilt);
 container.appendChild(flipBtn);
 container.appendChild(closeBtn);
 modal.appendChild(container);
 
 modal.onclick=(e)=>{
  if(e.target===modal){
   modal.style.display='none';
  }
 };
};

document.getElementById('addCardBtn').onclick=()=>{
 const collectorNum=document.getElementById('collectorInput').value.trim();
 if(!collectorNum){alert('Please enter a collector number');return}
 
 const card=allCards.find(c=>c.collector_number===collectorNum);
 if(!card){alert(`Card with collector number ${collectorNum} not found in current set`);return}
 
 function getCardImages(card){
  if(card.image_uris){
   const front=card.image_uris.normal;
   const back=card.card_faces&&card.card_faces.length>1&&card.card_faces[1].image_uris?card.card_faces[1].image_uris.normal:MTG_CARD_BACK;
   return {front,back};
  }else if(card.card_faces&&card.card_faces.length>0){
   const front=card.card_faces[0].image_uris?card.card_faces[0].image_uris.normal:MTG_CARD_BACK;
   const back=card.card_faces.length>1&&card.card_faces[1].image_uris?card.card_faces[1].image_uris.normal:MTG_CARD_BACK;
   return {front,back};
  }
  return {front:MTG_CARD_BACK,back:MTG_CARD_BACK};
 }
 
 data.cards[currentSet]=data.cards[currentSet]||{};
 const id=card.id;
 const isSpotlight=storySpotlightCards.some(sc=>sc.id===card.id);
 const imgs=getCardImages(card);
 
 if(!data.cards[currentSet][id]){
  data.cards[currentSet][id]={
   name:card.name,
   rarity:card.rarity,
   img:imgs.front,
   backImg:imgs.back,
   count:0,
   fullart:false,
   spotlight:isSpotlight,
   collectorNum:card.collector_number
  };
 }
 data.cards[currentSet][id].count++;
 save();
 render();
 updateStats();
 
 alert(`Added ${card.name} (${collectorNum}) to collection!`);
 document.getElementById('collectorInput').value='';
};

loadSets();
tick();
setInterval(tick,1000);
</script>
</body>
</html>