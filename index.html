<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>MTG Pocket</title>
<style>
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,Arial;background:radial-gradient(circle at top,#1b1b2f,#05050a);color:#fff;min-height:100vh;overflow-x:hidden}
header{display:flex;justify-content:space-between;align-items:center;padding:clamp(0.5rem,3vw,1rem) clamp(0.75rem,4vw,1.5rem);background:rgba(0,0,0,.6);backdrop-filter:blur(6px);gap:0.5rem;flex-wrap:wrap}
header h1{font-size:clamp(1.2rem,4vw,1.8rem);margin:0}
button{background:linear-gradient(135deg,#4facfe,#00f2fe);border:none;border-radius:10px;padding:clamp(0.5rem,2vw,0.6rem) clamp(0.75rem,3vw,1rem);font-weight:600;cursor:pointer;font-size:clamp(0.8rem,2vw,1rem);white-space:nowrap}
button:disabled{opacity:.4;cursor:not-allowed}
select{background:#111;color:#fff;border-radius:8px;padding:0.4rem;border:1px solid #333;font-size:clamp(0.8rem,2vw,1rem)}
.controls{display:flex;gap:clamp(0.5rem,2vw,1rem);flex-wrap:wrap;padding:clamp(0.5rem,2vw,1rem);align-items:center;font-size:clamp(0.85rem,2vw,1rem)}
.stats{padding:clamp(0.5rem,2vw,1rem);display:grid;grid-template-columns:repeat(auto-fit,minmax(min(140px,100%),1fr));gap:clamp(0.5rem,2vw,1rem)}
.statBox{background:#111;padding:clamp(0.75rem,2vw,1rem);border-radius:12px;cursor:pointer;text-align:center;font-size:clamp(0.85rem,2vw,1rem)}
.statBox.active{outline:2px solid #4facfe}
.progress{height:8px;background:#222;border-radius:6px;overflow:hidden;margin-top:6px}
.progress div{height:100%;background:linear-gradient(90deg,#4facfe,#00f2fe)}
.cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(min(120px,45vw),1fr));gap:clamp(0.5rem,2vw,1rem);padding:clamp(0.5rem,2vw,1rem)}
.card{position:relative;background:#111;border-radius:clamp(12px,3vw,16px);overflow:hidden;cursor:pointer}
.card img{width:100%;display:block;position:relative;z-index:1}
.card:hover{box-shadow:0 20px 40px rgba(0,0,0,.6)}
.count{position:absolute;bottom:clamp(4px,1vw,6px);right:clamp(4px,1vw,6px);background:rgba(0,0,0,.7);padding:2px 6px;border-radius:8px;font-size:clamp(0.7rem,2vw,0.75rem);z-index:2}
.new-card::after{content:'NEW';position:absolute;top:6px;left:6px;background:#ffd700;color:#000;font-weight:700;padding:2px 6px;border-radius:4px;font-size:clamp(0.65rem,2vw,0.75rem);z-index:10}
.story-card::before{content:'STORY';position:absolute;top:6px;right:6px;background:#3498db;color:#fff;font-weight:700;padding:2px 6px;border-radius:4px;font-size:clamp(0.65rem,2vw,0.75rem);z-index:10}
.card-placeholder{position:relative;background:#1a1a2a;border:2px dashed #333;border-radius:clamp(12px,3vw,16px);overflow:hidden;display:flex;align-items:center;justify-content:center;aspect-ratio:2.5/3.5;color:#666;font-size:clamp(0.8rem,2vw,1rem);font-weight:600}
.rarity-common{border:2px solid #999}
.rarity-uncommon{border:2px solid #1eff00}
.rarity-rare{border:2px solid #0070dd}
.rarity-mythic{border:2px solid #ff8000}

@keyframes ripOpen{
  0%{transform:scale(1) rotate(0deg);filter:brightness(1);clip-path:none}
  15%{transform:scale(1.05) rotate(-3deg);filter:brightness(1.2);clip-path:none}
  30%{transform:scale(1.05) rotate(3deg);filter:brightness(1.2);clip-path:none}
  45%{transform:scale(1) rotate(0deg);filter:brightness(1);clip-path:none}
  50%, 69%{
    transform:scale(1) rotate(0deg);
    filter:brightness(1);
    clip-path:none;
  }
  70%{
    clip-path:polygon(0 0, 100% 0, 100% 30%, 0 35%);
    filter:brightness(2);
  }
  85%{
    clip-path:polygon(0 0, 100% 0, 100% 30%, 0 35%);
    transform:translateY(-40px) scale(1.05);
    opacity:0.5;
  }
  100%{
    clip-path:polygon(0 0, 100% 0, 100% 30%, 0 35%);
    transform:translateY(-80px) scale(1);
    opacity:0;
  }
}
@keyframes ripOpenBottom{
  0%, 69%{
    opacity:0;
    clip-path:polygon(0 35%, 100% 30%, 100% 100%, 0 100%);
    transform:translateY(0) scale(1);
  }
  70%{
    opacity:1;
    clip-path:polygon(0 35%, 100% 30%, 100% 100%, 0 100%);
    transform:translateY(0) scale(1);
  }
  85%{
    clip-path:polygon(0 35%, 100% 30%, 100% 100%, 0 100%);
    transform:translateY(40px) scale(0.95);
    opacity:0.5;
  }
  100%{
    clip-path:polygon(0 35%, 100% 30%, 100% 100%, 0 100%);
    transform:translateY(80px) scale(0.9);
    opacity:0;
  }
}
@keyframes swordSlice{
  0%, 45%{
    left:-220px;
    opacity:0;
  }
  48%{
    left:-20px;
    opacity:1;
  }
  62%{
    left:100%;
    opacity:1;
  }
  65%{
    left:calc(100% + 50px);
    opacity:0;
  }
  100%{
    left:calc(100% + 50px);
    opacity:0;
  }
}
@keyframes cardExit{
  0%{transform:translateX(0) rotateY(0deg);opacity:1}
  100%{transform:translateX(100vw) rotateY(270deg);opacity:0}
}
@keyframes godpack{
  0%,100%{box-shadow:0 0 20px rgba(255,215,0,0.5),0 0 40px rgba(255,215,0,0.3)}
  50%{box-shadow:0 0 40px rgba(255,215,0,0.9),0 0 80px rgba(255,215,0,0.5)}
}
.godpack{animation:godpack 1s ease-in-out infinite;border:3px solid gold !important}
.bonus-glow{position:absolute;inset:-10px;background:radial-gradient(circle,rgba(255,107,107,0.4),transparent 70%);border-radius:inherit;z-index:0;animation:pulseGlow 2s ease-in-out infinite;pointer-events:none}
@keyframes pulseGlow{
  0%,100%{opacity:0.5;transform:scale(1)}
  50%{opacity:1;transform:scale(1.1)}
}

#homeScreen{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:60vh;padding:2rem}
.packImage{position:relative;width:clamp(250px,40vw,350px);height:clamp(400px,64vw,560px);margin:2rem auto;cursor:pointer;transition:transform .2s;background:linear-gradient(145deg,#2a2a3e,#1a1a2e);border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.5);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:2rem;gap:1.5rem;border:3px solid rgba(79,172,254,0.3);overflow:visible}
.packImage:hover{transform:scale(1.05)}
.packImage.ripping{animation:ripOpen 0.8s ease-out forwards;position:relative;overflow:visible !important}
.packImage.ripping::before{
  content:'';
  position:absolute;
  top:32.5%;
  left:-10%;
  width:200px;
  height:6px;
  background:linear-gradient(90deg, 
    transparent 0%, 
    rgba(79,172,254,0.3) 20%,
    rgba(79,172,254,0.6) 40%,
    rgba(79,172,254,0.9) 60%,
    rgba(255,255,255,1) 80%,
    rgba(255,255,255,1) 100%);
  box-shadow:
    0 0 15px 5px rgba(255,255,255,0.8),
    0 0 25px 8px rgba(79,172,254,0.8),
    0 0 35px 10px rgba(79,172,254,0.6);
  transform:rotate(-2.86deg);
  transform-origin:right center;
  z-index:1000;
  animation:swordSlice 0.8s ease-in forwards;
  pointer-events:none;
  border-radius:3px;
}
.packImage.ripping::after{
  content:'';
  position:absolute;
  inset:0;
  background:inherit;
  border-radius:inherit;
  border:inherit;
  animation:ripOpenBottom 0.8s ease-out forwards;
  z-index:1;
}
.packLogo{width:80%;max-width:200px;height:auto;object-fit:contain;filter:drop-shadow(0 5px 15px rgba(79,172,254,0.6))}
.packIcon{width:clamp(60px,15vw,100px);height:clamp(60px,15vw,100px);object-fit:contain;filter:drop-shadow(0 5px 15px rgba(79,172,254,0.4))}
.packBg{position:absolute;inset:0;background:radial-gradient(circle at center,rgba(79,172,254,0.1),transparent);border-radius:20px;z-index:0}
.packContent{position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;gap:1.5rem}
.setDropdown{position:fixed;top:clamp(70px,15vw,90px);right:clamp(0.5rem,2vw,1rem);z-index:100;background:rgba(0,0,0,.8);padding:0.5rem;border-radius:10px;backdrop-filter:blur(10px)}
.navButtons{display:flex;gap:1rem;margin-top:1rem;flex-wrap:wrap;justify-content:center}

#packModal,#cardViewModal{position:fixed;inset:0;background:rgba(0,0,0,.95);display:none;align-items:center;justify-content:center;z-index:1000;padding:clamp(0.5rem,2vw,1rem);flex-direction:column}
.singleCardView{display:flex;align-items:center;justify-content:center;width:100%;height:100%;cursor:pointer;perspective:1000px}
.singleCardView .card{width:clamp(250px,60vw,400px);max-width:90vw;box-shadow:0 30px 80px rgba(0,0,0,0.8)}
.allCardsView{display:none}
.packCards{display:flex;gap:clamp(0.5rem,2vw,1rem);flex-wrap:wrap;justify-content:center;max-width:100%;align-items:center}
.packCards .card{width:clamp(100px,25vw,180px);max-width:180px}
#collectionView{display:none}

@media (max-width:768px){
  .packCards .card{width:clamp(120px,35vw,160px)}
  .packImage{width:clamp(220px,50vw,300px);height:clamp(352px,80vw,480px)}
  .packLogo{width:75%}
  .packIcon{width:clamp(50px,12vw,80px);height:clamp(50px,12vw,80px)}
}
@media (max-width:480px){
  header{flex-direction:column;text-align:center}
  .packCards{gap:0.75rem}
  .packCards .card{width:clamp(100px,40vw,140px)}
  .navButtons{gap:0.5rem}
}
</style>
</head>
<body>
<header>
  <h1>MTG Pocket</h1>
  <div>Points: <b id="points">0</b></div>
</header>

<div class="setDropdown">
  <label style="font-size:0.85rem">Set: <select id="setSelect"></select></label>
</div>

<div id="homeScreen">
  <div class="packImage" id="packImage">
    <div class="packBg"></div>
    <div class="packContent">
      <img src="" alt="Set Logo" id="packLogo" class="packLogo">
      <img src="" alt="Set Icon" id="packIcon" class="packIcon">
    </div>
  </div>
  <button id="openPackHome" style="font-size:1.2rem;padding:1rem 2rem">Open Pack (6)</button>
  <div style="margin-top:1rem;font-size:0.9rem" id="countdown">Next point in: --:--</div>
  <div style="margin-top:1rem"><label><input type="checkbox" id="freeMode"> Free Packs</label></div>
  <div class="navButtons">
    <button id="viewCollection">View Collection</button>
  </div>
</div>

<div id="collectionView">
  <div class="controls">
    <button id="backHome">‚Üê Back to Home</button>
  </div>
  <div class="stats" id="stats"></div>
  <div id="collection" class="cards"></div>
</div>

<div id="packModal"></div>
<div id="cardViewModal"></div>

<script>
const PACK_COST=6,INTERVAL=3600000,FULLART_BONUS_CHANCE=0.10,GODPACK_CHANCE=0.015,MASTERPIECE_CHANCE=0.25;
let data=JSON.parse(localStorage.getItem('mtgPocket'))||{points:0,last:Date.now(),cards:{},lastPack:null};
let allCards=[],fullArtCards=[],masterpieceCards=[],storySpotlightCards=[],currentSet=null,setSize=0,activeRarity='all',setData={};

function migrateData(){
 Object.keys(data.cards).forEach(setCode=>{
  Object.keys(data.cards[setCode]).forEach(cardId=>{
   const card=data.cards[setCode][cardId];
   if(card.fullart===undefined){card.fullart=cardId.endsWith('_fullart')}
  });
 });
 save();
}
migrateData();

function save(){localStorage.setItem('mtgPocket',JSON.stringify(data))}

function enableTilt(el){
 el.onmousemove=e=>{const r=el.getBoundingClientRect();const x=(e.clientX-r.left)/r.width-.5;const y=(e.clientY-r.top)/r.height-.5;el.style.transform=`perspective(800px) rotateX(${-y*15}deg) rotateY(${x*15}deg) scale(1.05)`};
 el.onmouseleave=()=>el.style.transform='';
 el.ontouchmove=e=>{const t=e.touches[0];const r=el.getBoundingClientRect();const x=(t.clientX-r.left)/r.width-.5;const y=(t.clientY-r.top)/r.height-.5;el.style.transform=`perspective(800px) rotateX(${-y*15}deg) rotateY(${x*15}deg) scale(1.05)`};
 el.ontouchend=()=>el.style.transform='';
}

async function loadSets(){
 const r=await fetch('https://api.scryfall.com/sets');
 const j=await r.json();
 let sets=j.data.filter(s=>s.released_at&&s.card_count>100&&s.icon_svg_uri&&!s.parent_set_code&&!s.name.toLowerCase().includes('jumpstart')&&!s.name.toLowerCase().includes('promo')&&!/Commander\s*$/i.test(s.name));
 sets.sort((a,b)=>new Date(b.released_at)-new Date(a.released_at));
 const sel=document.getElementById('setSelect');
 sel.innerHTML='';
 sets.forEach(s=>{const o=document.createElement('option');o.value=s.code;o.textContent=s.name;sel.appendChild(o);setData[s.code]={name:s.name,icon:s.icon_svg_uri}});
 
 j.data.forEach(s=>{if(!setData[s.code]){setData[s.code]={name:s.name,icon:s.icon_svg_uri,parent:s.parent_set_code,type:s.set_type}}});
 
 currentSet=data.lastPack||sel.value;
 sel.value=currentSet;
 loadSet();
}

async function loadSet(){
 const res=await fetch(`https://api.scryfall.com/cards/search?q=set:${currentSet}+game:paper&unique=cards`);
 const j=await res.json();
 allCards=j.data.filter(c=>c.image_uris&&['common','uncommon','rare','mythic'].includes(c.rarity));
 
 allCards.sort((a,b)=>{
  const numA=parseInt(a.collector_number)||0;
  const numB=parseInt(b.collector_number)||0;
  return numA-numB;
 });
 
 try{const faRes=await fetch(`https://api.scryfall.com/cards/search?q=set:${currentSet}+game:paper+(is:extended+OR+is:fullart)&unique=cards`);const faJson=await faRes.json();fullArtCards=faJson.data.filter(c=>c.image_uris)}catch(e){fullArtCards=[]}
 
 masterpieceCards=[];
 const allSetCodes=Object.keys(setData);
 const childMasterpieceSets=allSetCodes.filter(code=>setData[code].parent===currentSet&&setData[code].type==='masterpiece');
 if(childMasterpieceSets.length>0){
  for(const childCode of childMasterpieceSets){
   try{
    const mpRes=await fetch(`https://api.scryfall.com/cards/search?q=set:${childCode}+game:paper&unique=cards`);
    const mpJson=await mpRes.json();
    masterpieceCards.push(...mpJson.data.filter(c=>c.image_uris));
   }catch(e){}
  }
 }
 
 storySpotlightCards=[];
 try{
  const ssRes=await fetch(`https://api.scryfall.com/cards/search?q=set:${currentSet}+is:spotlight&unique=cards`);
  const ssJson=await ssRes.json();
  storySpotlightCards=ssJson.data.filter(c=>c.image_uris);
  storySpotlightCards.sort((a,b)=>{
   const numA=parseInt(a.collector_number)||0;
   const numB=parseInt(b.collector_number)||0;
   return numA-numB;
  });
 }catch(e){}
 
 setSize=allCards.length;
 updatePackImage();
 render();
 updateStats();
}

function updatePackImage(){
 const logo=document.getElementById('packLogo');
 const icon=document.getElementById('packIcon');
 logo.src=`https://www.mtgpics.com/graph/sets/logos_big/${currentSet}.png`;
 logo.onerror=()=>{logo.style.display='none'};
 logo.onload=()=>{logo.style.display='block'};
 if(setData[currentSet]&&setData[currentSet].icon){icon.src=setData[currentSet].icon;icon.style.display='block'}else{icon.style.display='none'}
}

function roll(){let r=Math.random()*100;if(r<1)return'mythic';if(r<10)return'rare';if(r<30)return'uncommon';return'common'}

function tick(){
 const now=Date.now();
 const diff=now-data.last;
 const h=Math.floor(diff/INTERVAL);
 if(h>0){data.points+=h;data.last+=h*INTERVAL;save()}
 const rem=INTERVAL-(now-data.last);
 const m=Math.floor(rem/60000),s=Math.floor(rem%60000/1000);
 document.getElementById('countdown').textContent=`Next point in: ${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
 update();
}

async function openPack(){
 const free=document.getElementById('freeMode').checked;
 if(!free&&data.points<PACK_COST) return;
 const packImg=document.getElementById('packImage');
 packImg.classList.add('ripping');
 await new Promise(resolve=>setTimeout(resolve,800));
 packImg.classList.remove('ripping');
 if(!free) data.points-=PACK_COST;
 data.cards[currentSet]=data.cards[currentSet]||{};
 data.lastPack=currentSet;
 const isGodPack=Math.random()<GODPACK_CHANCE&&fullArtCards.length>0;
 let pack=[];
 if(isGodPack){
  for(let i=0;i<5;i++){
   const card=fullArtCards[Math.floor(Math.random()*fullArtCards.length)];
   const id=card.id+'_fullart';
   const isNew=!data.cards[currentSet][id];
   if(!data.cards[currentSet][id]){data.cards[currentSet][id]={name:card.name,rarity:card.rarity,img:card.image_uris.normal,count:0,fullart:true,collectorNum:card.collector_number}}
   data.cards[currentSet][id].count++;
   pack.push({...data.cards[currentSet][id],isNew,isGodPack:true});
  }
 }else{
  for(let i=0;i<5;i++){
   const rarity=roll();
   const pool=allCards.filter(c=>c.rarity===rarity);
   const card=pool[Math.floor(Math.random()*pool.length)];
   const id=card.id;
   const isNew=!data.cards[currentSet][id];
   
   const isSpotlight=storySpotlightCards.some(sc=>sc.id===card.id);
   
   if(!data.cards[currentSet][id]){data.cards[currentSet][id]={name:card.name,rarity:card.rarity,img:card.image_uris.normal,count:0,fullart:false,spotlight:isSpotlight,collectorNum:card.collector_number}}
   data.cards[currentSet][id].count++;
   pack.push({...data.cards[currentSet][id],isNew});
  }
  
  let got6thCard=false;
  if(Math.random()<FULLART_BONUS_CHANCE&&fullArtCards.length>0){
   const card=fullArtCards[Math.floor(Math.random()*fullArtCards.length)];
   const id=card.id+'_fullart';
   const isNew=!data.cards[currentSet][id];
   if(!data.cards[currentSet][id]){data.cards[currentSet][id]={name:card.name,rarity:card.rarity,img:card.image_uris.normal,count:0,fullart:true,collectorNum:card.collector_number}}
   data.cards[currentSet][id].count++;
   pack.push({...data.cards[currentSet][id],isNew,isBonus:true});
   got6thCard=true;
  }
  
  if(got6thCard && Math.random()<MASTERPIECE_CHANCE&&masterpieceCards.length>0){
   const card=masterpieceCards[Math.floor(Math.random()*masterpieceCards.length)];
   const id=card.id+'_masterpiece';
   const isNew=!data.cards[currentSet][id];
   if(!data.cards[currentSet][id]){data.cards[currentSet][id]={name:card.name,rarity:card.rarity,img:card.image_uris.normal,count:0,masterpiece:true,collectorNum:card.collector_number}}
   data.cards[currentSet][id].count++;
   pack.push({...data.cards[currentSet][id],isNew,isSecret:true});
  }
 }
 save();
 updatePackImage();
 showPack(pack,isGodPack);
 update();
}

function showPack(pack,isGodPack){
 const m=document.getElementById('packModal');
 m.style.display='flex';
 if(isGodPack){m.innerHTML='<div style="text-align:center;margin-bottom:1rem"><h2 style="color:#ffd700;font-size:2rem;text-shadow:0 0 20px rgba(255,215,0,0.8)">üåü GOD PACK! üåü</h2></div><div class="singleCardView"></div><div class="allCardsView"><div class="packCards"></div></div>'}else{m.innerHTML='<div class="singleCardView"></div><div class="allCardsView"><div class="packCards"></div></div>'}
 const singleView=m.querySelector('.singleCardView');
 const allView=m.querySelector('.allCardsView');
 const allCardsContainer=m.querySelector('.packCards');
 const regularCards=pack.filter(card=>!card.isBonus&&!card.isSecret);
 const bonusCards=pack.filter(card=>card.isBonus);
 const secretCards=pack.filter(card=>card.isSecret);
 const allPackCards=[...regularCards,...bonusCards,...secretCards];
 let currentIndex=0;
 let allCardsShown=false;
 function closeModal(){m.style.display='none';m.innerHTML='';render()}
 function showNextCard(){
  if(currentIndex<allPackCards.length){
   const card=allPackCards[currentIndex];
   const isBonus=card.isBonus;
   const isSecret=card.isSecret;
   if(singleView.children.length>0){const existingCard=singleView.children[0];existingCard.style.animation='cardExit 0.5s ease-in forwards';setTimeout(()=>{showCardInternal(card,isBonus,isSecret)},500)}else{showCardInternal(card,isBonus,isSecret)}
  }else{
   if(singleView.children.length>0){const existingCard=singleView.children[0];existingCard.style.animation='cardExit 0.5s ease-in forwards';setTimeout(()=>{singleView.style.display='none';allView.style.display='block';allCardsShown=true;singleView.onclick=null},500)}else{singleView.style.display='none';allView.style.display='block';allCardsShown=true;singleView.onclick=null}
  }
 }
 function showCardInternal(card,isBonus,isSecret){
  singleView.innerHTML='';
  const d=document.createElement('div');
  d.className=`card rarity-${card.rarity}`;
  d.innerHTML=`<img src="${card.img}"><div class="count">x${card.count}</div>`;
  if(card.isNew) d.classList.add('new-card');
  if(card.spotlight===true) d.classList.add('story-card');
  if(card.isGodPack) d.classList.add('godpack');
  
  if(card.masterpiece===true || isSecret===true){
   d.classList.add('godpack');
   d.style.filter='brightness(1.5) drop-shadow(0 0 30px rgba(155,89,182,0.9))';
   const glowDiv=document.createElement('div');
   glowDiv.className='bonus-glow';
   glowDiv.style.background='radial-gradient(circle,rgba(155,89,182,0.6),transparent 70%)';
   d.insertBefore(glowDiv,d.firstChild);
  }else if(isBonus===true){
   d.classList.add('godpack');
   d.style.filter='brightness(1.3) drop-shadow(0 0 20px rgba(255,107,107,0.8))';
   const glowDiv=document.createElement('div');
   glowDiv.className='bonus-glow';
   d.insertBefore(glowDiv,d.firstChild);
  }
  
  singleView.appendChild(d);
  const dSmall=cardEl(card,false);
  if(card.isNew) dSmall.classList.add('new-card');
  if(card.spotlight===true) dSmall.classList.add('story-card');
  if(card.isGodPack) dSmall.classList.add('godpack');
  
  if(card.masterpiece===true || isSecret===true){
   dSmall.classList.add('godpack');
   const glowDiv=document.createElement('div');
   glowDiv.className='bonus-glow';
   glowDiv.style.background='radial-gradient(circle,rgba(155,89,182,0.6),transparent 70%)';
   dSmall.insertBefore(glowDiv,dSmall.firstChild);
  }else if(isBonus===true){
   dSmall.classList.add('godpack');
   addBonusGlow(dSmall);
  }
  
  allCardsContainer.appendChild(dSmall);
  currentIndex++;
 }
 showNextCard();
 singleView.onclick=showNextCard;
 m.onclick=(e)=>{if(allCardsShown&&e.target===m){closeModal()}};
 allView.onclick=(e)=>{if(e.target===allView||e.target.closest('.packCards')===allCardsContainer){closeModal()}};
}

function addBonusGlow(cardElement){const glowDiv=document.createElement('div');glowDiv.className='bonus-glow';cardElement.insertBefore(glowDiv,cardElement.firstChild)}

function cardEl(card,isRevealing){
 const d=document.createElement('div');
 d.className=`card rarity-${card.rarity}`;
 d.innerHTML=`<img src="${card.img}"><div class="count">x${card.count}</div>`;
 if(!isRevealing){enableTilt(d);d.onclick=e=>{e.stopPropagation();showCard(card)}}
 return d;
}

function showCard(card){const m=document.getElementById('cardViewModal');m.style.display='flex';m.innerHTML='';const d=cardEl(card);d.style.maxWidth='300px';m.appendChild(d);m.onclick=()=>{m.style.display='none';m.innerHTML=''}}

function render(){
 const col=document.getElementById('collection');
 col.innerHTML='';
 if(!allCards.length){return}
 
 const owned=data.cards[currentSet]||{};
 
 const ownedByName={};
 Object.values(owned).forEach(c=>{
  if(!ownedByName[c.name]){ownedByName[c.name]=[]}
  ownedByName[c.name].push(c);
 });
 
 if(activeRarity==='secrets'){
  const masterpieceList=Object.values(owned).filter(c=>c.masterpiece===true);
  masterpieceList.sort((a,b)=>{
   const numA=parseInt(a.collectorNum)||0;
   const numB=parseInt(b.collectorNum)||0;
   return numA-numB;
  });
  masterpieceList.forEach(c=>{col.appendChild(cardEl(c))});
  
 }else if(activeRarity==='spotlight'){
  storySpotlightCards.forEach((card)=>{
   const variants=ownedByName[card.name]||[];
   const ownedSpotlight=variants.find(v=>v.spotlight===true);
   if(ownedSpotlight){
    col.appendChild(cardEl(ownedSpotlight));
   }else{
    const placeholder=document.createElement('div');
    placeholder.className='card-placeholder';
    placeholder.textContent=`#${card.collector_number}`;
    col.appendChild(placeholder);
   }
  });
  
 }else if(activeRarity==='fullart'){
  const fullartList=Object.values(owned).filter(c=>c.fullart===true);
  fullartList.sort((a,b)=>{
   const numA=parseInt(a.collectorNum)||0;
   const numB=parseInt(b.collectorNum)||0;
   return numA-numB;
  });
  fullartList.forEach(c=>{col.appendChild(cardEl(c))});
  
 }else if(activeRarity==='all'){
  allCards.forEach((card)=>{
   const variants=ownedByName[card.name]||[];
   const regularCard=variants.find(v=>v.fullart===false);
   if(regularCard){
    col.appendChild(cardEl(regularCard));
   }else{
    const placeholder=document.createElement('div');
    placeholder.className='card-placeholder';
    placeholder.textContent=`#${card.collector_number}`;
    col.appendChild(placeholder);
   }
  });
  
  const fullartList=Object.values(owned).filter(c=>c.fullart===true);
  fullartList.sort((a,b)=>{
   const numA=parseInt(a.collectorNum)||0;
   const numB=parseInt(b.collectorNum)||0;
   return numA-numB;
  });
  fullartList.forEach(c=>{col.appendChild(cardEl(c))});
  
  const spotlightList=Object.values(owned).filter(c=>c.spotlight===true);
  spotlightList.sort((a,b)=>{
   const numA=parseInt(a.collectorNum)||0;
   const numB=parseInt(b.collectorNum)||0;
   return numA-numB;
  });
  spotlightList.forEach(c=>{col.appendChild(cardEl(c))});
  
  const masterpieceList=Object.values(owned).filter(c=>c.masterpiece===true);
  masterpieceList.sort((a,b)=>{
   const numA=parseInt(a.collectorNum)||0;
   const numB=parseInt(b.collectorNum)||0;
   return numA-numB;
  });
  masterpieceList.forEach(c=>{col.appendChild(cardEl(c))});
  
 }else{
  allCards.forEach((card)=>{
   if(card.rarity!==activeRarity){return}
   const variants=ownedByName[card.name]||[];
   const regularCard=variants.find(v=>v.fullart===false);
   if(regularCard){
    col.appendChild(cardEl(regularCard));
   }else{
    const placeholder=document.createElement('div');
    placeholder.className='card-placeholder';
    placeholder.textContent=`#${card.collector_number}`;
    col.appendChild(placeholder);
   }
  });
 }
}

function updateStats(){
 const statsEl=document.getElementById('stats');
 if(!currentSet){return}
 const owned=data.cards[currentSet]||{};
 const uniqueOwned={common:0,uncommon:0,rare:0,mythic:0};
 const ownedNames=new Set();
 Object.values(owned).forEach(c=>{
  if(c.fullart===false && !ownedNames.has(c.name)){uniqueOwned[c.rarity]++;ownedNames.add(c.name)}
 });
 const totals={common:0,uncommon:0,rare:0,mythic:0};
 allCards.forEach(c=>totals[c.rarity]++);
 const fullartTotal=fullArtCards.length;
 const fullartOwned=Object.values(owned).filter(c=>c.fullart===true).length;
 const masterpieceOwned=Object.values(owned).filter(c=>c.masterpiece===true).length;
 const storySpotlightOwned=Object.values(owned).filter(c=>c.spotlight===true).length;
 const storySpotlightTotal=storySpotlightCards.length;
 const totalCollected=ownedNames.size+fullartOwned+storySpotlightOwned+masterpieceOwned;
 statsEl.innerHTML=`<div class='statBox' data-rarity='all'><b>All Cards</b> ${totalCollected}</div>${['common','uncommon','rare','mythic'].map(r=>`<div class='statBox' data-rarity='${r}'><b>${r.toUpperCase()}</b> ${uniqueOwned[r]}/${totals[r]}<div class='progress'><div style='width:${totals[r]?uniqueOwned[r]/totals[r]*100:0}%'></div></div></div>`).join('')}<div class='statBox' data-rarity='fullart' style='background:linear-gradient(135deg,#2a2a3e,#1a1a2e);border:2px solid #ff6b6b'><b>FULL ART</b> ${fullartOwned}/${fullartTotal}<div class='progress'><div style='width:${fullartTotal?fullartOwned/fullartTotal*100:0}%;background:linear-gradient(90deg,#ff6b6b,#ee5a6f)'></div></div></div>${storySpotlightTotal>0?`<div class='statBox' data-rarity='spotlight' style='background:linear-gradient(135deg,#2a3a4e,#1a2a3e);border:2px solid #3498db'><b>STORY SPOTLIGHT</b> ${storySpotlightOwned}/${storySpotlightTotal}<div class='progress'><div style='width:${storySpotlightTotal?storySpotlightOwned/storySpotlightTotal*100:0}%;background:linear-gradient(90deg,#3498db,#2980b9)'></div></div></div>`:''}${masterpieceCards.length>0?`<div class='statBox' data-rarity='secrets' style='background:linear-gradient(135deg,#3a1a5e,#1a0a2e);border:2px solid #9b59b6'><b>SECRETS</b> ${masterpieceOwned}</div>`:''}`;
 statsEl.querySelectorAll('.statBox').forEach(box=>{box.onclick=()=>{activeRarity=box.dataset.rarity;statsEl.querySelectorAll('.statBox').forEach(b=>b.classList.remove('active'));box.classList.add('active');render()}});
}

function update(){
 document.getElementById('points').textContent=data.points;
 const btn=document.getElementById('openPackHome');
 btn.disabled=!document.getElementById('freeMode').checked&&data.points<PACK_COST;
}

function showHome(){document.getElementById('homeScreen').style.display='flex';document.getElementById('collectionView').style.display='none'}
function showCollection(){
 document.getElementById('homeScreen').style.display='none';
 document.getElementById('collectionView').style.display='block';
 render();
 updateStats();
}

document.getElementById('openPackHome').onclick=openPack;
document.getElementById('packImage').onclick=openPack;
document.getElementById('viewCollection').onclick=showCollection;
document.getElementById('backHome').onclick=showHome;
document.getElementById('setSelect').onchange=e=>{currentSet=e.target.value;loadSet()};
document.getElementById('freeMode').onchange=update;

loadSets();
tick();
setInterval(tick,1000);
</script>
</body>
</html>